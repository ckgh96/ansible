---

- name: configure iptables
  hosts: all
  tasks:
    - include_vars: config/vars.yaml

    - name: install iptables persistent
      apt: name=netfilter-persistent state=present update_cache=true

    - name: flush existing firewall rules
      iptables:
        flush: true

    - name: flush iptables other rules
      command: iptables -X

    - name: allow loop back
      iptables: chain=INPUT action=append in_interface=lo jump=ACCEPT

    - name: allow established and related traffic
      iptables:
        chain: INPUT
        ctstate: ESTABLISHED,RELATED
        jump: ACCEPT

    - name: allow SSH traffic
      iptables:
        chain: INPUT
        destination_port: "{{ sshport }}"
        jump: ACCEPT
        protocol: tcp

    - name: allow SSH traffic
      iptables:
        chain: INPUT
        destination_port: 22
        jump: ACCEPT
        protocol: tcp

    - name: drop other inputs
      iptables:
        chain: INPUT
        jump: DROP

    - name: save ipv4 rules
      community.general.iptables_state:
        state: saved
        path: /etc/iptables/rules.v4

    - name: save ipv6 rules
      community.general.iptables_state:
        ip_version: ipv6
        table: filter
        state: saved
        path: /etc/iptables/rules.v6

    - name: disable IPv6
      lineinfile: dest=/etc/sysctl.conf
                  line="net.ipv6.conf.all.disable_ipv6 = 1\nnet.ipv6.conf.default.disable_ipv6 = 1\nnet.ipv6.conf.lo.disable_ipv6 = 1"
                  insertbefore=EOF

    - name: reload sysctl
      command: sysctl -p

    - name: Install unattended-upgrades
      package:
        name: unattended-upgrades
        state: present

    - name: allow updates
      lineinfile: dest=/etc/apt/apt.conf.d/50unattended-upgrades
                  regexp="^//(.*)-updates(.*)"
                  line=\1-updates\2
                  state=present

    - name: allow automatic reboots
      lineinfile: dest=/etc/apt/apt.conf.d/50unattended-upgrades
                  regexp="//Unattended-Upgrade::Automatic-Reboot \"false\";"
                  line="Unattended-Upgrade::Automatic-Reboot \"true\""
                  state=present

    - name: remove unused kernel packages
      lineinfile: dest=/etc/apt/apt.conf.d/50unattended-upgrades
                  regexp="//Unattended-Upgrade::Remove-Unused-Kernel-Packages \"true\";"
                  line="Unattended-Upgrade::Remove-Unused-Kernel-Packages \"true\";"
                  state=present

    - name: remove new unused dependencies
      lineinfile: dest=/etc/apt/apt.conf.d/50unattended-upgrades
                  regexp="//Unattended-Upgrade::Remove-New-Unused-Dependencies \"true\";"
                  line="Unattended-Upgrade::Remove-New-Unused-Dependencies \"true\";"
                  state=present

    - name: remove unused dependencies
      lineinfile: dest=/etc/apt/apt.conf.d/50unattended-upgrades
                  regexp="//Unattended-Upgrade::Remove-Unused-Dependencies \"false\";"
                  line="Unattended-Upgrade::Remove-Unused-Dependencies \"true\";"
                  state=present

    - name: Download-Upgradeable-Packages
      lineinfile: dest=/etc/apt/apt.conf.d/10periodic
                  regexp="APT::Periodic::Download-Upgradeable-Packages \"0\";"
                  line="APT::Periodic::Download-Upgradeable-Packages \"1\";"
                  state=present

    - name: set AutocleanInterval
      lineinfile: dest=/etc/apt/apt.conf.d/10periodic
                  regexp="APT::Periodic::AutocleanInterval \"0\";"
                  line="APT::Periodic::AutocleanInterval \"7\";"
                  state=present

    - name: set AutocleanInterval
      file:
        path: /home/{{ user_name }}/.ssh
        state: directory
        mode: 700
        owner: "{{ user_name }}"
        group: "{{ user_name }}"

    - name: Change file ownership, group and permissions
      file:
        path: /home/{{ user_name }}/.ssh/authorized_keys
        owner: "{{ user_name }}"
        group: "{{ user_name }}"
        mode: '0644'
